name: Data Pipeline

on:
  schedule:
    # Every 6 hours: 00:00, 06:00, 12:00, 18:00 UTC
    - cron: "0 */6 * * *"
  workflow_dispatch:
    inputs:
      skip_dbt:
        description: "Skip dbt transforms (ingestion only)"
        required: false
        default: "false"
        type: choice
        options: ["false", "true"]

jobs:
  ingest-and-transform:
    name: Ingest flights + dbt transforms
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      # Full pre-built connection string stored directly in secret
      WAREHOUSE_URL: ${{ secrets.WAREHOUSE_URL }}
      PGSSLMODE: require
      # Individual params kept for dbt profiles.yml
      DBT_HOST: ${{ secrets.RENDER_DB_HOST }}
      DBT_USER: ${{ secrets.RENDER_DB_USER }}
      DBT_PASS: ${{ secrets.RENDER_DB_PASSWORD }}
      DBT_DBNAME: ${{ secrets.RENDER_DB_NAME }}
      # Amadeus API
      AMADEUS_CLIENT_ID: ${{ secrets.AMADEUS_CLIENT_ID }}
      AMADEUS_CLIENT_SECRET: ${{ secrets.AMADEUS_CLIENT_SECRET }}
      AMADEUS_ENV: "production"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: data/scripts/requirements.txt

      - name: Install script dependencies
        run: pip install -r data/scripts/requirements.txt

      - name: Set up bronze tables (idempotent)
        working-directory: data/scripts
        run: python -c "from db_utils import setup_bronze_tables; setup_bronze_tables()"

      - name: Ingest flights (all French airports)
        working-directory: data/scripts
        run: python ingest_flights.py

      - name: Install dbt
        if: ${{ github.event.inputs.skip_dbt != 'true' }}
        run: pip install dbt-postgres==1.8.0

      - name: Run dbt transforms
        if: ${{ github.event.inputs.skip_dbt != 'true' }}
        working-directory: data/dbt
        run: |
          dbt deps
          dbt seed --target prod
          dbt run --target prod --exclude silver_hostels gold_combo_deals
          dbt test --target prod --exclude silver_hostels gold_combo_deals --store-failures
