name: Data Pipeline

on:
  schedule:
    # Every 6 hours: 00:00, 06:00, 12:00, 18:00 UTC
    - cron: "0 */6 * * *"
  workflow_dispatch:
    inputs:
      skip_dbt:
        description: "Skip dbt transforms (ingestion only)"
        required: false
        default: "false"
        type: choice
        options: ["false", "true"]

jobs:
  ingest-and-transform:
    name: Ingest flights + dbt transforms
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      # Full pre-built connection string stored directly in secret
      WAREHOUSE_URL: ${{ secrets.WAREHOUSE_URL }}
      # Individual params kept for dbt profiles.yml
      DBT_HOST: ${{ secrets.RENDER_DB_HOST }}
      DBT_USER: ${{ secrets.RENDER_DB_USER }}
      DBT_PASS: ${{ secrets.RENDER_DB_PASSWORD }}
      DBT_DBNAME: ${{ secrets.RENDER_DB_NAME }}
      # Amadeus API
      AMADEUS_CLIENT_ID: ${{ secrets.AMADEUS_CLIENT_ID }}
      AMADEUS_CLIENT_SECRET: ${{ secrets.AMADEUS_CLIENT_SECRET }}
      AMADEUS_ENV: "production"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: data/scripts/requirements.txt

      - name: Install script dependencies
        run: pip install -r data/scripts/requirements.txt

      - name: Diagnose DB connectivity
        run: |
          python3 - <<'PYEOF'
          import os, re, psycopg2, socket

          url = os.getenv("WAREHOUSE_URL", "")
          print(f"WAREHOUSE_URL set: {bool(url)}")

          m = re.search(r'@([^:/]+)', url)
          host = m.group(1) if m else "unknown"
          print(f"Target host: {host}")

          try:
              ip = socket.getaddrinfo(host, 5432)[0][4][0]
              print(f"Resolved IP: {ip}")
          except Exception as e:
              print(f"DNS resolution failed: {e}")

          try:
              s = socket.create_connection((host, 5432), timeout=10)
              s.close()
              print("TCP port 5432: reachable")
          except Exception as e:
              print(f"TCP port 5432: FAILED - {e}")

          base = re.sub(r'[?&]sslmode=\w+', '', url)
          for mode in ('prefer', 'require', 'disable'):
              try:
                  conn = psycopg2.connect(f"{base}?sslmode={mode}&connect_timeout=15")
                  print(f"sslmode={mode}: SUCCESS")
                  conn.close()
              except Exception as e:
                  print(f"sslmode={mode}: FAILED - {e}")
          PYEOF

      - name: Set up bronze tables (idempotent)
        working-directory: data/scripts
        run: python -c "from db_utils import setup_bronze_tables; setup_bronze_tables()"

      - name: Ingest flights (all French airports)
        working-directory: data/scripts
        run: python ingest_flights.py

      - name: Install dbt
        if: ${{ github.event.inputs.skip_dbt != 'true' }}
        run: pip install dbt-postgres==1.8.0

      - name: Run dbt transforms
        if: ${{ github.event.inputs.skip_dbt != 'true' }}
        working-directory: data/dbt
        run: |
          dbt deps
          dbt run --target prod --exclude silver_hostels gold_combo_deals
          dbt test --target prod --exclude silver_hostels gold_combo_deals --store-failures
